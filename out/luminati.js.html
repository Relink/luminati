<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: luminati.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: luminati.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// luminati.js
var Promise = require('bluebird');
var lookup = Promise.promisify(require('dns').lookup);

// This just creates a random number.
function _makeSessionId() {
  var date = '' + Date.now();
  return date + Math.floor(Math.random() * 10000000)
}


// Creates the string for the super-proxy domain to be looked up.
// We send a new session id in order to get a new super proxy.
function _getDomain (session_id, country) {
  return `servercountry-${country}-session-${session_id}.zproxy.luminati.io`
}

// Keeps track of latest IP for super proxy to use.
function _host (interval, country) {
  var host = false;

  // periodically resolve DNS fom zproxy, which will
  // give their currently fastest super proxies.
  // This also means we don't perform this DNS resolution
  // at call time.
  var stopInterval = setInterval(() => {
    var id = _makeSessionId();
    lookup(_getDomain(id, country))
      .then(_host => {
        host = _host;
      })
  }, interval)

  return {

    // get takes the current session id and returns either the
    // current host, if we hav already resolved one, or resolves
    // one asynchronously if we don't yet have one.
    get: function get (id) {
      if (host) {
        return Promise.resolve(host);
      };
      // if we don't have a host, resolve one, and cache it!
      return lookup(_getDomain(id, country))
        .then(_host => {
          host = _host;
          return _host;
        });
    },
    cleanup: clearInterval.bind(null, stopInterval)
  };
};

/**
 * @typedef {Object} LuminatiConfig
 * @property {String} username luminati username in the form USER-zone-ZONE
 * @property {String} password luminati password
 * @property {Number} [frequency = 60000] frequency, in ms, that you want to refresh the DNS
 * of the super-proxy you are using.
 * @property {String} [superProxyLocation = gb] country code to use for super proxy location.
 * @property {String} [exitLocation] country code if you want exit node to be in a specific
 * country. If not provided, will provide exit nodes in random countries.
 * @property {String} [dnsResolution = local] can be 'local' or 'remote' - where the final
 * url should have its DNS resolved, locally at the super proxy, or remotes at the exit node.
 * @property {Boolean} [https = false] whether you want to use an https proxy url or not.
 */


/**
 * Luminati!!
 * @constructor
 * @param {LuminatiConfig} config
 *
 *
 */
function Luminati (config) {
  this.port = 22225;
  this.dns = config.dnsResolution == 'remote' ? 'dns-remote' : 'dns-local';
  this.password = config.password;
  this.spCountry = config.superProxyLocation || 'gb';
  this.country = config.exitLocation ? `-country-${config.exitLocation}` : '';
  this.user = `lum-customer-${config.username}${this.country}-${this.dns}`;
  this.s = config.https ? 's' : '';

  // Set the super proxy host to redo DNS lookup every 60 seconds.
  var refresh = config.refresh || 60000;
  this.host = _host(refresh, this.spCountry);
}

Luminati.prototype._makeProxyString = function (host, id) {
  return `http${this.s}://${this.user}-session-${id}:${this.password}@${host}:${this.port}`
}

/**
 * getProxy is what you call every time you need a new exit node.
 * @function
 * @returns {String} This is the entire string used as "host" when
 * making http requests!
 *
 * @example

var request = require('request');
var Luminati = require('luminati');

var luminati = new Luminati({
  username: 'myusername-zone-myzone',
  password: 'mypassword
});

luminati.getProxy().then(proxy => {
  request({ url: 'http://coolurl.com', proxy: proxy })
   .pipe(toWherever)
});

 */
Luminati.prototype.getProxy = function () {
  var self = this;
  var id = _makeSessionId();
  return this.host.get(id)
    .then(host => self._makeProxyString(host, id))
}



/******************* EXPORTS **************************
******************************************************/
module.exports = {
  _makeSessionId: _makeSessionId,
  _host: _host,
  Luminati: Luminati
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Luminati.html">Luminati</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Thu Mar 03 2016 17:41:31 GMT+0100 (CET)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
