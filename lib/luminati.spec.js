'use strict';

// spec
var chai = require('chai');
chai.use(require('sinon-chai'));
var expect = chai.expect;
var sinon = require('sinon');
var nock = require('nock');
var proxyquire = require('proxyquire');

var lookupMock = sinon.stub();

var luminati = proxyquire('./luminati', {
  dns: {
    lookup: lookupMock
  }
});

describe('luminati', function () {

  beforeEach(function () {
    lookupMock.reset();
  });

  describe('_makeSessionId', function () {
    it('returns a nice random string every time', function () {
      var one = luminati._makeSessionId();
      var two = luminati._makeSessionId();
      expect(one).not.to.equal(two);
      expect(one.length > 16);
    });
  });

  describe('_host', function () {
    it('calls lookup on the dns when called before its interval ' + 'gives it a chance to call itslef', function (done) {

      var time = 10000;
      var start = Date.now();
      var host = luminati._host(time);

      lookupMock.callsArgWith(1, null, Promise.resolve('foo'));

      host.get(1).then(function (ip) {
        var elapsed = Date.now() - start;
        expect(elapsed > time);
        expect(ip).to.equal('foo');
        expect(lookupMock).to.have.been.calledOnce;
        host.cleanup();
        done();
      });
    });

    it('it will resolve immediately if called after first interval', function (done) {
      var time = 20;
      var host = luminati._host(time);

      var responses = ['foo', 'bar', 'baz'];

      lookupMock.onCall(0).callsArgWith(1, null, Promise.resolve(responses[0]));
      lookupMock.onCall(1).callsArgWith(1, null, Promise.resolve(responses[1]));
      lookupMock.onCall(2).callsArgWith(1, null, Promise.resolve(responses[2]));

      setTimeout(function () {
        var count = lookupMock.callCount;
        host.get(1).then(function (ip) {
          expect(lookupMock.callCount).to.equal(count);
          expect(ip).to.equal(responses[count - 1]);
          host.cleanup();
          done();
        });
      }, time * 3);
    });

    it('calls lookup with a string that takes into account country and id', function () {

      // NOTE: this is implicitly testing _getDomain
      var host = luminati._host(10000, 'gb');
      host.get(1);
      expect(lookupMock.firstCall.args[0]).to.equal('servercountry-gb-session-1.zproxy.luminati.io');
      host.cleanup();
    });
  });

  describe('getProxy', function () {
    it('returns a string with the user and password from config', function (done) {
      var config = {
        username: 'user',
        password: 'secret'
      };

      lookupMock.onCall(0).callsArgWith(1, null, Promise.resolve('qux'));
      var lum = new luminati.Luminati(config);

      lum.getProxy().then(function (proxy) {
        expect(proxy).to.match(/customer\-user\-dns/);
        expect(proxy).to.match(/\:secret\@qux/);
        expect(lookupMock.firstCall.args[0]).to.match(/servercountry-gb/);
        lum.host.cleanup();
        done();
      });
    });

    it('reflects https, country, and dnsResolution options in final string', function (done) {
      var config = {
        username: 'user',
        password: 'secret',
        dnsResolution: 'remote',
        exitLocation: 'nl',
        https: true
      };

      lookupMock.onCall(0).callsArgWith(1, null, Promise.resolve('qux'));
      var lum = new luminati.Luminati(config);

      lum.getProxy().then(function (proxy) {
        expect(proxy).to.match(/dns\-remote/);
        expect(proxy).to.match(/country\-nl/);
        lum.host.cleanup();
        done();
      });
    });

    it('reflects superProxyLocation in its call to lookup location', function () {
      var config = {
        username: 'user',
        password: 'secret',
        superProxyLocation: 'nl'
      };

      var lum = new luminati.Luminati(config);

      lum.getProxy();
      expect(lookupMock.firstCall.args[0]).to.match(/servercountry-nl/);
      lum.host.cleanup();
    });
  });
});
//# sourceMappingURL=data:application/json;base64,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LElBQUksU0FBUyxRQUFULENBQWtCLE1BQXRCLENBQU4sQ0FQaUU7O0FBU3JFLFVBQUksUUFBSixHQVRxRTtBQVVyRSxhQUFPLFdBQVcsU0FBWCxDQUFxQixJQUFyQixDQUEwQixDQUExQixDQUFQLEVBQXFDLEVBQXJDLENBQXdDLEtBQXhDLENBQThDLGtCQUE5QyxFQVZxRTtBQVdyRSxVQUFJLElBQUosQ0FBUyxPQUFULEdBWHFFO0tBQU4sQ0FBakUsQ0F6Q3lCO0dBQU4sQ0FBckIsQ0F2RXlCO0NBQU4sQ0FBckIiLCJmaWxlIjoibHVtaW5hdGkuc3BlYy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHNwZWNcbnZhciBjaGFpID0gcmVxdWlyZSgnY2hhaScpO1xuY2hhaS51c2UocmVxdWlyZSgnc2lub24tY2hhaScpKTtcbnZhciBleHBlY3QgPSBjaGFpLmV4cGVjdDtcbnZhciBzaW5vbiA9IHJlcXVpcmUoJ3Npbm9uJyk7XG52YXIgbm9jayA9IHJlcXVpcmUoJ25vY2snKTtcbnZhciBwcm94eXF1aXJlID0gcmVxdWlyZSgncHJveHlxdWlyZScpO1xuXG52YXIgbG9va3VwTW9jayA9IHNpbm9uLnN0dWIoKTtcblxudmFyIGx1bWluYXRpID0gcHJveHlxdWlyZSgnLi9sdW1pbmF0aScsIHtcbiAgZG5zOiB7XG4gICAgbG9va3VwOiBsb29rdXBNb2NrXG4gIH1cbn0pO1xuXG5kZXNjcmliZSgnbHVtaW5hdGknLCAoKSA9PiB7XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgbG9va3VwTW9jay5yZXNldCgpO1xuICB9KVxuXG4gIGRlc2NyaWJlKCdfbWFrZVNlc3Npb25JZCcsICgpID0+IHtcbiAgICBpdCgncmV0dXJucyBhIG5pY2UgcmFuZG9tIHN0cmluZyBldmVyeSB0aW1lJywgKCkgPT4ge1xuICAgICAgdmFyIG9uZSA9IGx1bWluYXRpLl9tYWtlU2Vzc2lvbklkKCk7XG4gICAgICB2YXIgdHdvID0gbHVtaW5hdGkuX21ha2VTZXNzaW9uSWQoKTtcbiAgICAgIGV4cGVjdChvbmUpLm5vdC50by5lcXVhbCh0d28pO1xuICAgICAgZXhwZWN0KG9uZS5sZW5ndGggPiAxNik7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdfaG9zdCcsICgpID0+IHtcbiAgICBpdCgnY2FsbHMgbG9va3VwIG9uIHRoZSBkbnMgd2hlbiBjYWxsZWQgYmVmb3JlIGl0cyBpbnRlcnZhbCAnICtcbiAgICAgICAnZ2l2ZXMgaXQgYSBjaGFuY2UgdG8gY2FsbCBpdHNsZWYnLCBkb25lID0+IHtcblxuICAgICAgICAgdmFyIHRpbWUgPSAxMDAwMDtcbiAgICAgICAgIHZhciBzdGFydCA9IERhdGUubm93KCk7XG4gICAgICAgICB2YXIgaG9zdCA9IGx1bWluYXRpLl9ob3N0KHRpbWUpO1xuXG4gICAgICAgICBsb29rdXBNb2NrLmNhbGxzQXJnV2l0aCgxLCBudWxsLCBQcm9taXNlLnJlc29sdmUoJ2ZvbycpKTtcblxuICAgICAgICAgaG9zdFxuICAgICAgICAgICAuZ2V0KDEpXG4gICAgICAgICAgIC50aGVuKGlwID0+IHtcbiAgICAgICAgICAgICB2YXIgZWxhcHNlZCA9IERhdGUubm93KCkgLSBzdGFydDtcbiAgICAgICAgICAgICBleHBlY3QoZWxhcHNlZCA+IHRpbWUpO1xuICAgICAgICAgICAgIGV4cGVjdChpcCkudG8uZXF1YWwoJ2ZvbycpO1xuICAgICAgICAgICAgIGV4cGVjdChsb29rdXBNb2NrKS50by5oYXZlLmJlZW4uY2FsbGVkT25jZTtcbiAgICAgICAgICAgICBob3N0LmNsZWFudXAoKVxuICAgICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgICAgfSk7XG4gICAgICAgfSk7XG5cbiAgICBpdCgnaXQgd2lsbCByZXNvbHZlIGltbWVkaWF0ZWx5IGlmIGNhbGxlZCBhZnRlciBmaXJzdCBpbnRlcnZhbCcsIGRvbmUgPT4ge1xuICAgICAgdmFyIHRpbWUgPSAyMDtcbiAgICAgIHZhciBob3N0ID0gbHVtaW5hdGkuX2hvc3QodGltZSk7XG5cbiAgICAgIHZhciByZXNwb25zZXMgPSBbJ2ZvbycsICdiYXInLCAnYmF6J107XG5cbiAgICAgIGxvb2t1cE1vY2sub25DYWxsKDApLmNhbGxzQXJnV2l0aCgxLCBudWxsLCBQcm9taXNlLnJlc29sdmUocmVzcG9uc2VzWzBdKSk7XG4gICAgICBsb29rdXBNb2NrLm9uQ2FsbCgxKS5jYWxsc0FyZ1dpdGgoMSwgbnVsbCwgUHJvbWlzZS5yZXNvbHZlKHJlc3BvbnNlc1sxXSkpO1xuICAgICAgbG9va3VwTW9jay5vbkNhbGwoMikuY2FsbHNBcmdXaXRoKDEsIG51bGwsIFByb21pc2UucmVzb2x2ZShyZXNwb25zZXNbMl0pKTtcblxuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIHZhciBjb3VudCA9IGxvb2t1cE1vY2suY2FsbENvdW50O1xuICAgICAgICBob3N0XG4gICAgICAgICAgLmdldCgxKVxuICAgICAgICAgIC50aGVuKGlwID0+IHtcbiAgICAgICAgICAgIGV4cGVjdChsb29rdXBNb2NrLmNhbGxDb3VudCkudG8uZXF1YWwoY291bnQpO1xuICAgICAgICAgICAgZXhwZWN0KGlwKS50by5lcXVhbChyZXNwb25zZXNbY291bnQgLSAxXSk7XG4gICAgICAgICAgICBob3N0LmNsZWFudXAoKTtcbiAgICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgICB9KTtcbiAgICAgIH0sIHRpbWUqMyk7XG4gICAgfSk7XG5cbiAgICBpdCgnY2FsbHMgbG9va3VwIHdpdGggYSBzdHJpbmcgdGhhdCB0YWtlcyBpbnRvIGFjY291bnQgY291bnRyeSBhbmQgaWQnLCAoKSA9PiB7XG5cbiAgICAgIC8vIE5PVEU6IHRoaXMgaXMgaW1wbGljaXRseSB0ZXN0aW5nIF9nZXREb21haW5cbiAgICAgIHZhciBob3N0ID0gbHVtaW5hdGkuX2hvc3QoMTAwMDAsICdnYicpO1xuICAgICAgaG9zdC5nZXQoMSlcbiAgICAgIGV4cGVjdChsb29rdXBNb2NrLmZpcnN0Q2FsbC5hcmdzWzBdKVxuICAgICAgICAudG8uZXF1YWwoJ3NlcnZlcmNvdW50cnktZ2Itc2Vzc2lvbi0xLnpwcm94eS5sdW1pbmF0aS5pbycpO1xuICAgICAgaG9zdC5jbGVhbnVwKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdnZXRQcm94eScsICgpID0+IHtcbiAgICBpdCgncmV0dXJucyBhIHN0cmluZyB3aXRoIHRoZSB1c2VyIGFuZCBwYXNzd29yZCBmcm9tIGNvbmZpZycsIGRvbmUgPT4ge1xuICAgICAgdmFyIGNvbmZpZyA9IHtcbiAgICAgICAgdXNlcm5hbWU6ICd1c2VyJyxcbiAgICAgICAgcGFzc3dvcmQ6ICdzZWNyZXQnXG4gICAgICB9XG5cbiAgICAgIGxvb2t1cE1vY2sub25DYWxsKDApLmNhbGxzQXJnV2l0aCgxLCBudWxsLCBQcm9taXNlLnJlc29sdmUoJ3F1eCcpKTtcbiAgICAgIHZhciBsdW0gPSBuZXcgbHVtaW5hdGkuTHVtaW5hdGkoY29uZmlnKTtcblxuICAgICAgbHVtLmdldFByb3h5KClcbiAgICAgICAgLnRoZW4ocHJveHkgPT4ge1xuICAgICAgICAgIGV4cGVjdChwcm94eSkudG8ubWF0Y2goL2N1c3RvbWVyXFwtdXNlclxcLWRucy8pO1xuICAgICAgICAgIGV4cGVjdChwcm94eSkudG8ubWF0Y2goL1xcOnNlY3JldFxcQHF1eC8pO1xuICAgICAgICAgIGV4cGVjdChsb29rdXBNb2NrLmZpcnN0Q2FsbC5hcmdzWzBdKS50by5tYXRjaCgvc2VydmVyY291bnRyeS1nYi8pXG4gICAgICAgICAgbHVtLmhvc3QuY2xlYW51cCgpO1xuICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgncmVmbGVjdHMgaHR0cHMsIGNvdW50cnksIGFuZCBkbnNSZXNvbHV0aW9uIG9wdGlvbnMgaW4gZmluYWwgc3RyaW5nJywgZG9uZSA9PiB7XG4gICAgICB2YXIgY29uZmlnID0ge1xuICAgICAgICB1c2VybmFtZTogJ3VzZXInLFxuICAgICAgICBwYXNzd29yZDogJ3NlY3JldCcsXG4gICAgICAgIGRuc1Jlc29sdXRpb246ICdyZW1vdGUnLFxuICAgICAgICBleGl0TG9jYXRpb246ICdubCcsXG4gICAgICAgIGh0dHBzOiB0cnVlXG4gICAgICB9O1xuXG4gICAgICBsb29rdXBNb2NrLm9uQ2FsbCgwKS5jYWxsc0FyZ1dpdGgoMSwgbnVsbCwgUHJvbWlzZS5yZXNvbHZlKCdxdXgnKSk7XG4gICAgICB2YXIgbHVtID0gbmV3IGx1bWluYXRpLkx1bWluYXRpKGNvbmZpZyk7XG5cbiAgICAgIGx1bS5nZXRQcm94eSgpXG4gICAgICAgIC50aGVuKHByb3h5ID0+IHtcbiAgICAgICAgICBleHBlY3QocHJveHkpLnRvLm1hdGNoKC9kbnNcXC1yZW1vdGUvKTtcbiAgICAgICAgICBleHBlY3QocHJveHkpLnRvLm1hdGNoKC9jb3VudHJ5XFwtbmwvKVxuICAgICAgICAgIGx1bS5ob3N0LmNsZWFudXAoKTtcbiAgICAgICAgICBkb25lKCk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3JlZmxlY3RzIHN1cGVyUHJveHlMb2NhdGlvbiBpbiBpdHMgY2FsbCB0byBsb29rdXAgbG9jYXRpb24nLCAoKSA9PiB7XG4gICAgICB2YXIgY29uZmlnID0ge1xuICAgICAgICB1c2VybmFtZTogJ3VzZXInLFxuICAgICAgICBwYXNzd29yZDogJ3NlY3JldCcsXG4gICAgICAgIHN1cGVyUHJveHlMb2NhdGlvbjogJ25sJ1xuICAgICAgfTtcblxuICAgICAgdmFyIGx1bSA9IG5ldyBsdW1pbmF0aS5MdW1pbmF0aShjb25maWcpO1xuXG4gICAgICBsdW0uZ2V0UHJveHkoKTtcbiAgICAgIGV4cGVjdChsb29rdXBNb2NrLmZpcnN0Q2FsbC5hcmdzWzBdKS50by5tYXRjaCgvc2VydmVyY291bnRyeS1ubC8pXG4gICAgICBsdW0uaG9zdC5jbGVhbnVwKCk7XG4gICAgfSk7XG4gIH0pO1xufSlcbiJdfQ==