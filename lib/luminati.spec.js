'use strict';

// spec
var chai = require('chai');
chai.use(require('sinon-chai'));
var expect = chai.expect;
var sinon = require('sinon');
var nock = require('nock');
var proxyquire = require('proxyquire');
var Promise = require('bluebird');
var lookupMock = sinon.stub();

var luminati = proxyquire('./luminati', {
  dns: {
    lookup: lookupMock
  }
});

describe('luminati', function () {

  beforeEach(function () {
    lookupMock.reset();
  });

  describe('_makeSessionId', function () {
    it('returns a nice random string every time', function () {
      var one = luminati._makeSessionId();
      var two = luminati._makeSessionId();
      expect(one).not.to.equal(two);
      expect(one.length > 16);
    });
  });

  describe('_host', function () {
    it('calls lookup on the dns when called before its interval ' + 'gives it a chance to call itslef', function (done) {

      var time = 10000;
      var start = Date.now();
      var host = luminati._host(time, true);

      lookupMock.callsArgWith(1, null, Promise.resolve('foo'));

      host.get(1).then(function (ip) {
        var elapsed = Date.now() - start;
        expect(elapsed > time);
        expect(ip).to.equal('foo');
        expect(lookupMock).to.have.been.calledOnce;
        host.cleanup();
        done();
      });
    });

    it('it will resolve immediately if called after first interval', function (done) {
      var time = 20;
      var host = luminati._host(time, true);

      var responses = ['foo', 'bar', 'baz'];

      lookupMock.onCall(0).callsArgWith(1, null, Promise.resolve(responses[0]));
      lookupMock.onCall(1).callsArgWith(1, null, Promise.resolve(responses[1]));
      lookupMock.onCall(2).callsArgWith(1, null, Promise.resolve(responses[2]));

      setTimeout(function () {
        var count = lookupMock.callCount;
        host.get(1).then(function (ip) {
          expect(lookupMock.callCount).to.equal(count);
          expect(ip).to.equal(responses[count - 1]);
          host.cleanup();
          done();
        });
      }, time * 3);
    });

    it('calls lookup with a string that takes into account country and id', function () {

      // NOTE: this is implicitly testing _getDomain
      var host = luminati._host(10000, true, 'nl');
      host.get(1);
      expect(lookupMock.firstCall.args[0]).to.equal('servercountry-nl-session-1.zproxy.luminati.io');
      host.cleanup();
    });

    it('does not call lookup when asked not to', function () {
      var host = luminati._host(10, false);
      expect(lookupMock).not.to.have.been.called;
    });
  });

  describe('getProxy', function () {
    it('returns a string with the user and password from config', function (done) {
      var config = {
        username: 'user',
        password: 'secret',
        cacheSuperProxy: true
      };

      lookupMock.onCall(0).callsArgWith(1, null, Promise.resolve('qux'));
      var lum = new luminati.Luminati(config);

      lum.getProxy().then(function (proxy) {
        expect(proxy).to.match(/customer\-user\-dns/);
        expect(proxy).to.match(/\:secret\@qux/);
        expect(lookupMock.firstCall.args[0]).to.match(/servercountry-gb/);
        lum.host.cleanup();
        done();
      });
    });

    it('does not lookup superProxy as a default', function (done) {
      var config = {
        username: 'user',
        password: 'secret'
      };

      var lum = new luminati.Luminati(config);

      lum.getProxy().then(function (proxy) {
        expect(lookupMock).not.to.have.been.called;
        expect(proxy).to.match(/zproxy\.luminati\.io/);
        done();
      });
    });

    it('ignores a user trying to cache if https is set to true', function (done) {
      var config = {
        username: 'user',
        password: 'secret',
        https: true,
        cacheSuperProxy: true,
        cacheTimeout: 10
      };

      var lum = new luminati.Luminati(config);

      lum.getProxy().then(function (proxy) {
        expect(lookupMock).not.to.have.been.called;
        expect(proxy).to.match(/zproxy\.luminati\.io/);
        done();
      });
    });

    it('reflects https, country, and dnsResolution options in final string', function (done) {
      var config = {
        username: 'user',
        password: 'secret',
        dnsResolution: 'remote',
        exitLocation: 'nl',
        https: true
      };

      var lum = new luminati.Luminati(config);

      lum.getProxy().then(function (proxy) {
        expect(proxy).to.match(/dns\-remote/);
        expect(proxy).to.match(/country\-nl/);

        // should not call lookup when https is true!
        expect(lookupMock).not.to.have.been.called;
        lum.host.cleanup();
        done();
      });
    });

    it('reflects superProxyLocation in its call to lookup location', function () {
      var config = {
        username: 'user',
        password: 'secret',
        superProxyLocation: 'nl',
        cacheSuperProxy: true
      };

      var lum = new luminati.Luminati(config);

      lum.getProxy();
      expect(lookupMock.firstCall.args[0]).to.match(/servercountry-nl/);
      lum.host.cleanup();
    });
  });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9sdW1pbmF0aS5zcGVjLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLElBQUksT0FBTyxRQUFRLE1BQVIsQ0FBUDtBQUNKLEtBQUssR0FBTCxDQUFTLFFBQVEsWUFBUixDQUFUO0FBQ0EsSUFBSSxTQUFTLEtBQUssTUFBTDtBQUNiLElBQUksUUFBUSxRQUFRLE9BQVIsQ0FBUjtBQUNKLElBQUksT0FBTyxRQUFRLE1BQVIsQ0FBUDtBQUNKLElBQUksYUFBYSxRQUFRLFlBQVIsQ0FBYjtBQUNKLElBQUksVUFBVSxRQUFRLFVBQVIsQ0FBVjtBQUNKLElBQUksYUFBYSxNQUFNLElBQU4sRUFBYjs7QUFFSixJQUFJLFdBQVcsV0FBVyxZQUFYLEVBQXlCO0FBQ3RDLE9BQUs7QUFDSCxZQUFRLFVBQVI7R0FERjtDQURhLENBQVg7O0FBTUosU0FBUyxVQUFULEVBQXFCLFlBQU07O0FBRXpCLGFBQVcsWUFBTTtBQUNmLGVBQVcsS0FBWCxHQURlO0dBQU4sQ0FBWCxDQUZ5Qjs7QUFNekIsV0FBUyxnQkFBVCxFQUEyQixZQUFNO0FBQy9CLE9BQUcseUNBQUgsRUFBOEMsWUFBTTtBQUNsRCxVQUFJLE1BQU0sU0FBUyxjQUFULEVBQU4sQ0FEOEM7QUFFbEQsVUFBSSxNQUFNLFNBQVMsY0FBVCxFQUFOLENBRjhDO0FBR2xELGFBQU8sR0FBUCxFQUFZLEdBQVosQ0FBZ0IsRUFBaEIsQ0FBbUIsS0FBbkIsQ0FBeUIsR0FBekIsRUFIa0Q7QUFJbEQsYUFBTyxJQUFJLE1BQUosR0FBYSxFQUFiLENBQVAsQ0FKa0Q7S0FBTixDQUE5QyxDQUQrQjtHQUFOLENBQTNCLENBTnlCOztBQWV6QixXQUFTLE9BQVQsRUFBa0IsWUFBTTtBQUN0QixPQUFHLDZEQUNBLGtDQURBLEVBQ29DLGdCQUFROztBQUUxQyxVQUFJLE9BQU8sS0FBUCxDQUZzQztBQUcxQyxVQUFJLFFBQVEsS0FBSyxHQUFMLEVBQVIsQ0FIc0M7QUFJMUMsVUFBSSxPQUFPLFNBQVMsS0FBVCxDQUFlLElBQWYsRUFBcUIsSUFBckIsQ0FBUCxDQUpzQzs7QUFNMUMsaUJBQVcsWUFBWCxDQUF3QixDQUF4QixFQUEyQixJQUEzQixFQUFpQyxRQUFRLE9BQVIsQ0FBZ0IsS0FBaEIsQ0FBakMsRUFOMEM7O0FBUTFDLFdBQ0csR0FESCxDQUNPLENBRFAsRUFFRyxJQUZILENBRVEsY0FBTTtBQUNWLFlBQUksVUFBVSxLQUFLLEdBQUwsS0FBYSxLQUFiLENBREo7QUFFVixlQUFPLFVBQVUsSUFBVixDQUFQLENBRlU7QUFHVixlQUFPLEVBQVAsRUFBVyxFQUFYLENBQWMsS0FBZCxDQUFvQixLQUFwQixFQUhVO0FBSVYsZUFBTyxVQUFQLEVBQW1CLEVBQW5CLENBQXNCLElBQXRCLENBQTJCLElBQTNCLENBQWdDLFVBQWhDLENBSlU7QUFLVixhQUFLLE9BQUwsR0FMVTtBQU1WLGVBTlU7T0FBTixDQUZSLENBUjBDO0tBQVIsQ0FEdkMsQ0FEc0I7O0FBc0J0QixPQUFHLDREQUFILEVBQWlFLGdCQUFRO0FBQ3ZFLFVBQUksT0FBTyxFQUFQLENBRG1FO0FBRXZFLFVBQUksT0FBTyxTQUFTLEtBQVQsQ0FBZSxJQUFmLEVBQXFCLElBQXJCLENBQVAsQ0FGbUU7O0FBSXZFLFVBQUksWUFBWSxDQUFDLEtBQUQsRUFBUSxLQUFSLEVBQWUsS0FBZixDQUFaLENBSm1FOztBQU12RSxpQkFBVyxNQUFYLENBQWtCLENBQWxCLEVBQXFCLFlBQXJCLENBQWtDLENBQWxDLEVBQXFDLElBQXJDLEVBQTJDLFFBQVEsT0FBUixDQUFnQixVQUFVLENBQVYsQ0FBaEIsQ0FBM0MsRUFOdUU7QUFPdkUsaUJBQVcsTUFBWCxDQUFrQixDQUFsQixFQUFxQixZQUFyQixDQUFrQyxDQUFsQyxFQUFxQyxJQUFyQyxFQUEyQyxRQUFRLE9BQVIsQ0FBZ0IsVUFBVSxDQUFWLENBQWhCLENBQTNDLEVBUHVFO0FBUXZFLGlCQUFXLE1BQVgsQ0FBa0IsQ0FBbEIsRUFBcUIsWUFBckIsQ0FBa0MsQ0FBbEMsRUFBcUMsSUFBckMsRUFBMkMsUUFBUSxPQUFSLENBQWdCLFVBQVUsQ0FBVixDQUFoQixDQUEzQyxFQVJ1RTs7QUFVdkUsaUJBQVcsWUFBTTtBQUNmLFlBQUksUUFBUSxXQUFXLFNBQVgsQ0FERztBQUVmLGFBQ0csR0FESCxDQUNPLENBRFAsRUFFRyxJQUZILENBRVEsY0FBTTtBQUNWLGlCQUFPLFdBQVcsU0FBWCxDQUFQLENBQTZCLEVBQTdCLENBQWdDLEtBQWhDLENBQXNDLEtBQXRDLEVBRFU7QUFFVixpQkFBTyxFQUFQLEVBQVcsRUFBWCxDQUFjLEtBQWQsQ0FBb0IsVUFBVSxRQUFRLENBQVIsQ0FBOUIsRUFGVTtBQUdWLGVBQUssT0FBTCxHQUhVO0FBSVYsaUJBSlU7U0FBTixDQUZSLENBRmU7T0FBTixFQVVSLE9BQUssQ0FBTCxDQVZILENBVnVFO0tBQVIsQ0FBakUsQ0F0QnNCOztBQTZDdEIsT0FBRyxtRUFBSCxFQUF3RSxZQUFNOzs7QUFHNUUsVUFBSSxPQUFPLFNBQVMsS0FBVCxDQUFlLEtBQWYsRUFBc0IsSUFBdEIsRUFBNEIsSUFBNUIsQ0FBUCxDQUh3RTtBQUk1RSxXQUFLLEdBQUwsQ0FBUyxDQUFULEVBSjRFO0FBSzVFLGFBQU8sV0FBVyxTQUFYLENBQXFCLElBQXJCLENBQTBCLENBQTFCLENBQVAsRUFDRyxFQURILENBQ00sS0FETixDQUNZLCtDQURaLEVBTDRFO0FBTzVFLFdBQUssT0FBTCxHQVA0RTtLQUFOLENBQXhFLENBN0NzQjs7QUF1RHRCLE9BQUcsd0NBQUgsRUFBNkMsWUFBTTtBQUNqRCxVQUFJLE9BQU8sU0FBUyxLQUFULENBQWUsRUFBZixFQUFtQixLQUFuQixDQUFQLENBRDZDO0FBRWpELGFBQU8sVUFBUCxFQUFtQixHQUFuQixDQUF1QixFQUF2QixDQUEwQixJQUExQixDQUErQixJQUEvQixDQUFvQyxNQUFwQyxDQUZpRDtLQUFOLENBQTdDLENBdkRzQjtHQUFOLENBQWxCLENBZnlCOztBQTRFekIsV0FBUyxVQUFULEVBQXFCLFlBQU07QUFDekIsT0FBRyx5REFBSCxFQUE4RCxnQkFBUTtBQUNwRSxVQUFJLFNBQVM7QUFDWCxrQkFBVSxNQUFWO0FBQ0Esa0JBQVUsUUFBVjtBQUNBLHlCQUFpQixJQUFqQjtPQUhFLENBRGdFOztBQU9wRSxpQkFBVyxNQUFYLENBQWtCLENBQWxCLEVBQXFCLFlBQXJCLENBQWtDLENBQWxDLEVBQXFDLElBQXJDLEVBQTJDLFFBQVEsT0FBUixDQUFnQixLQUFoQixDQUEzQyxFQVBvRTtBQVFwRSxVQUFJLE1BQU0sSUFBSSxTQUFTLFFBQVQsQ0FBa0IsTUFBdEIsQ0FBTixDQVJnRTs7QUFVcEUsVUFBSSxRQUFKLEdBQ0csSUFESCxDQUNRLGlCQUFTO0FBQ2IsZUFBTyxLQUFQLEVBQWMsRUFBZCxDQUFpQixLQUFqQixDQUF1QixxQkFBdkIsRUFEYTtBQUViLGVBQU8sS0FBUCxFQUFjLEVBQWQsQ0FBaUIsS0FBakIsQ0FBdUIsZUFBdkIsRUFGYTtBQUdiLGVBQU8sV0FBVyxTQUFYLENBQXFCLElBQXJCLENBQTBCLENBQTFCLENBQVAsRUFBcUMsRUFBckMsQ0FBd0MsS0FBeEMsQ0FBOEMsa0JBQTlDLEVBSGE7QUFJYixZQUFJLElBQUosQ0FBUyxPQUFULEdBSmE7QUFLYixlQUxhO09BQVQsQ0FEUixDQVZvRTtLQUFSLENBQTlELENBRHlCOztBQXFCekIsT0FBRyx5Q0FBSCxFQUE4QyxnQkFBUTtBQUNuRCxVQUFJLFNBQVM7QUFDWixrQkFBVSxNQUFWO0FBQ0Esa0JBQVUsUUFBVjtPQUZHLENBRCtDOztBQU1wRCxVQUFJLE1BQU0sSUFBSSxTQUFTLFFBQVQsQ0FBa0IsTUFBdEIsQ0FBTixDQU5nRDs7QUFRcEQsVUFBSSxRQUFKLEdBQ0csSUFESCxDQUNRLGlCQUFTO0FBQ2IsZUFBTyxVQUFQLEVBQW1CLEdBQW5CLENBQXVCLEVBQXZCLENBQTBCLElBQTFCLENBQStCLElBQS9CLENBQW9DLE1BQXBDLENBRGE7QUFFYixlQUFPLEtBQVAsRUFBYyxFQUFkLENBQWlCLEtBQWpCLENBQXVCLHNCQUF2QixFQUZhO0FBR2IsZUFIYTtPQUFULENBRFIsQ0FSb0Q7S0FBUixDQUE5QyxDQXJCeUI7O0FBc0N6QixPQUFHLHdEQUFILEVBQTZELGdCQUFRO0FBQ2xFLFVBQUksU0FBUztBQUNYLGtCQUFVLE1BQVY7QUFDQSxrQkFBVSxRQUFWO0FBQ0EsZUFBTyxJQUFQO0FBQ0EseUJBQWlCLElBQWpCO0FBQ0Esc0JBQWMsRUFBZDtPQUxFLENBRDhEOztBQVNuRSxVQUFJLE1BQU0sSUFBSSxTQUFTLFFBQVQsQ0FBa0IsTUFBdEIsQ0FBTixDQVQrRDs7QUFXbkUsVUFBSSxRQUFKLEdBQ0csSUFESCxDQUNRLGlCQUFTO0FBQ2IsZUFBTyxVQUFQLEVBQW1CLEdBQW5CLENBQXVCLEVBQXZCLENBQTBCLElBQTFCLENBQStCLElBQS9CLENBQW9DLE1BQXBDLENBRGE7QUFFYixlQUFPLEtBQVAsRUFBYyxFQUFkLENBQWlCLEtBQWpCLENBQXVCLHNCQUF2QixFQUZhO0FBR2IsZUFIYTtPQUFULENBRFIsQ0FYbUU7S0FBUixDQUE3RCxDQXRDeUI7O0FBMER6QixPQUFHLG9FQUFILEVBQXlFLGdCQUFRO0FBQy9FLFVBQUksU0FBUztBQUNYLGtCQUFVLE1BQVY7QUFDQSxrQkFBVSxRQUFWO0FBQ0EsdUJBQWUsUUFBZjtBQUNBLHNCQUFjLElBQWQ7QUFDQSxlQUFPLElBQVA7T0FMRSxDQUQyRTs7QUFTL0UsVUFBSSxNQUFNLElBQUksU0FBUyxRQUFULENBQWtCLE1BQXRCLENBQU4sQ0FUMkU7O0FBVy9FLFVBQUksUUFBSixHQUNHLElBREgsQ0FDUSxpQkFBUztBQUNiLGVBQU8sS0FBUCxFQUFjLEVBQWQsQ0FBaUIsS0FBakIsQ0FBdUIsYUFBdkIsRUFEYTtBQUViLGVBQU8sS0FBUCxFQUFjLEVBQWQsQ0FBaUIsS0FBakIsQ0FBdUIsYUFBdkI7OztBQUZhLGNBS2IsQ0FBTyxVQUFQLEVBQW1CLEdBQW5CLENBQXVCLEVBQXZCLENBQTBCLElBQTFCLENBQStCLElBQS9CLENBQW9DLE1BQXBDLENBTGE7QUFNYixZQUFJLElBQUosQ0FBUyxPQUFULEdBTmE7QUFPYixlQVBhO09BQVQsQ0FEUixDQVgrRTtLQUFSLENBQXpFLENBMUR5Qjs7QUFpRnpCLE9BQUcsNERBQUgsRUFBaUUsWUFBTTtBQUNyRSxVQUFJLFNBQVM7QUFDWCxrQkFBVSxNQUFWO0FBQ0Esa0JBQVUsUUFBVjtBQUNBLDRCQUFvQixJQUFwQjtBQUNBLHlCQUFpQixJQUFqQjtPQUpFLENBRGlFOztBQVFyRSxVQUFJLE1BQU0sSUFBSSxTQUFTLFFBQVQsQ0FBa0IsTUFBdEIsQ0FBTixDQVJpRTs7QUFVckUsVUFBSSxRQUFKLEdBVnFFO0FBV3JFLGFBQU8sV0FBVyxTQUFYLENBQXFCLElBQXJCLENBQTBCLENBQTFCLENBQVAsRUFBcUMsRUFBckMsQ0FBd0MsS0FBeEMsQ0FBOEMsa0JBQTlDLEVBWHFFO0FBWXJFLFVBQUksSUFBSixDQUFTLE9BQVQsR0FacUU7S0FBTixDQUFqRSxDQWpGeUI7R0FBTixDQUFyQixDQTVFeUI7Q0FBTixDQUFyQiIsImZpbGUiOiJsdW1pbmF0aS5zcGVjLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gc3BlY1xudmFyIGNoYWkgPSByZXF1aXJlKCdjaGFpJyk7XG5jaGFpLnVzZShyZXF1aXJlKCdzaW5vbi1jaGFpJykpO1xudmFyIGV4cGVjdCA9IGNoYWkuZXhwZWN0O1xudmFyIHNpbm9uID0gcmVxdWlyZSgnc2lub24nKTtcbnZhciBub2NrID0gcmVxdWlyZSgnbm9jaycpO1xudmFyIHByb3h5cXVpcmUgPSByZXF1aXJlKCdwcm94eXF1aXJlJyk7XG52YXIgUHJvbWlzZSA9IHJlcXVpcmUoJ2JsdWViaXJkJyk7XG52YXIgbG9va3VwTW9jayA9IHNpbm9uLnN0dWIoKTtcblxudmFyIGx1bWluYXRpID0gcHJveHlxdWlyZSgnLi9sdW1pbmF0aScsIHtcbiAgZG5zOiB7XG4gICAgbG9va3VwOiBsb29rdXBNb2NrXG4gIH1cbn0pO1xuXG5kZXNjcmliZSgnbHVtaW5hdGknLCAoKSA9PiB7XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgbG9va3VwTW9jay5yZXNldCgpO1xuICB9KVxuXG4gIGRlc2NyaWJlKCdfbWFrZVNlc3Npb25JZCcsICgpID0+IHtcbiAgICBpdCgncmV0dXJucyBhIG5pY2UgcmFuZG9tIHN0cmluZyBldmVyeSB0aW1lJywgKCkgPT4ge1xuICAgICAgdmFyIG9uZSA9IGx1bWluYXRpLl9tYWtlU2Vzc2lvbklkKCk7XG4gICAgICB2YXIgdHdvID0gbHVtaW5hdGkuX21ha2VTZXNzaW9uSWQoKTtcbiAgICAgIGV4cGVjdChvbmUpLm5vdC50by5lcXVhbCh0d28pO1xuICAgICAgZXhwZWN0KG9uZS5sZW5ndGggPiAxNik7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdfaG9zdCcsICgpID0+IHtcbiAgICBpdCgnY2FsbHMgbG9va3VwIG9uIHRoZSBkbnMgd2hlbiBjYWxsZWQgYmVmb3JlIGl0cyBpbnRlcnZhbCAnICtcbiAgICAgICAnZ2l2ZXMgaXQgYSBjaGFuY2UgdG8gY2FsbCBpdHNsZWYnLCBkb25lID0+IHtcblxuICAgICAgICAgdmFyIHRpbWUgPSAxMDAwMDtcbiAgICAgICAgIHZhciBzdGFydCA9IERhdGUubm93KCk7XG4gICAgICAgICB2YXIgaG9zdCA9IGx1bWluYXRpLl9ob3N0KHRpbWUsIHRydWUpO1xuXG4gICAgICAgICBsb29rdXBNb2NrLmNhbGxzQXJnV2l0aCgxLCBudWxsLCBQcm9taXNlLnJlc29sdmUoJ2ZvbycpKTtcblxuICAgICAgICAgaG9zdFxuICAgICAgICAgICAuZ2V0KDEpXG4gICAgICAgICAgIC50aGVuKGlwID0+IHtcbiAgICAgICAgICAgICB2YXIgZWxhcHNlZCA9IERhdGUubm93KCkgLSBzdGFydDtcbiAgICAgICAgICAgICBleHBlY3QoZWxhcHNlZCA+IHRpbWUpO1xuICAgICAgICAgICAgIGV4cGVjdChpcCkudG8uZXF1YWwoJ2ZvbycpO1xuICAgICAgICAgICAgIGV4cGVjdChsb29rdXBNb2NrKS50by5oYXZlLmJlZW4uY2FsbGVkT25jZTtcbiAgICAgICAgICAgICBob3N0LmNsZWFudXAoKVxuICAgICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgICAgfSk7XG4gICAgICAgfSk7XG5cbiAgICBpdCgnaXQgd2lsbCByZXNvbHZlIGltbWVkaWF0ZWx5IGlmIGNhbGxlZCBhZnRlciBmaXJzdCBpbnRlcnZhbCcsIGRvbmUgPT4ge1xuICAgICAgdmFyIHRpbWUgPSAyMDtcbiAgICAgIHZhciBob3N0ID0gbHVtaW5hdGkuX2hvc3QodGltZSwgdHJ1ZSk7XG5cbiAgICAgIHZhciByZXNwb25zZXMgPSBbJ2ZvbycsICdiYXInLCAnYmF6J107XG5cbiAgICAgIGxvb2t1cE1vY2sub25DYWxsKDApLmNhbGxzQXJnV2l0aCgxLCBudWxsLCBQcm9taXNlLnJlc29sdmUocmVzcG9uc2VzWzBdKSk7XG4gICAgICBsb29rdXBNb2NrLm9uQ2FsbCgxKS5jYWxsc0FyZ1dpdGgoMSwgbnVsbCwgUHJvbWlzZS5yZXNvbHZlKHJlc3BvbnNlc1sxXSkpO1xuICAgICAgbG9va3VwTW9jay5vbkNhbGwoMikuY2FsbHNBcmdXaXRoKDEsIG51bGwsIFByb21pc2UucmVzb2x2ZShyZXNwb25zZXNbMl0pKTtcblxuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIHZhciBjb3VudCA9IGxvb2t1cE1vY2suY2FsbENvdW50O1xuICAgICAgICBob3N0XG4gICAgICAgICAgLmdldCgxKVxuICAgICAgICAgIC50aGVuKGlwID0+IHtcbiAgICAgICAgICAgIGV4cGVjdChsb29rdXBNb2NrLmNhbGxDb3VudCkudG8uZXF1YWwoY291bnQpO1xuICAgICAgICAgICAgZXhwZWN0KGlwKS50by5lcXVhbChyZXNwb25zZXNbY291bnQgLSAxXSk7XG4gICAgICAgICAgICBob3N0LmNsZWFudXAoKTtcbiAgICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgICB9KTtcbiAgICAgIH0sIHRpbWUqMyk7XG4gICAgfSk7XG5cbiAgICBpdCgnY2FsbHMgbG9va3VwIHdpdGggYSBzdHJpbmcgdGhhdCB0YWtlcyBpbnRvIGFjY291bnQgY291bnRyeSBhbmQgaWQnLCAoKSA9PiB7XG5cbiAgICAgIC8vIE5PVEU6IHRoaXMgaXMgaW1wbGljaXRseSB0ZXN0aW5nIF9nZXREb21haW5cbiAgICAgIHZhciBob3N0ID0gbHVtaW5hdGkuX2hvc3QoMTAwMDAsIHRydWUsICdubCcpO1xuICAgICAgaG9zdC5nZXQoMSlcbiAgICAgIGV4cGVjdChsb29rdXBNb2NrLmZpcnN0Q2FsbC5hcmdzWzBdKVxuICAgICAgICAudG8uZXF1YWwoJ3NlcnZlcmNvdW50cnktbmwtc2Vzc2lvbi0xLnpwcm94eS5sdW1pbmF0aS5pbycpO1xuICAgICAgaG9zdC5jbGVhbnVwKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnZG9lcyBub3QgY2FsbCBsb29rdXAgd2hlbiBhc2tlZCBub3QgdG8nLCAoKSA9PiB7XG4gICAgICB2YXIgaG9zdCA9IGx1bWluYXRpLl9ob3N0KDEwLCBmYWxzZSk7XG4gICAgICBleHBlY3QobG9va3VwTW9jaykubm90LnRvLmhhdmUuYmVlbi5jYWxsZWQ7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdnZXRQcm94eScsICgpID0+IHtcbiAgICBpdCgncmV0dXJucyBhIHN0cmluZyB3aXRoIHRoZSB1c2VyIGFuZCBwYXNzd29yZCBmcm9tIGNvbmZpZycsIGRvbmUgPT4ge1xuICAgICAgdmFyIGNvbmZpZyA9IHtcbiAgICAgICAgdXNlcm5hbWU6ICd1c2VyJyxcbiAgICAgICAgcGFzc3dvcmQ6ICdzZWNyZXQnLFxuICAgICAgICBjYWNoZVN1cGVyUHJveHk6IHRydWUsXG4gICAgICB9XG5cbiAgICAgIGxvb2t1cE1vY2sub25DYWxsKDApLmNhbGxzQXJnV2l0aCgxLCBudWxsLCBQcm9taXNlLnJlc29sdmUoJ3F1eCcpKTtcbiAgICAgIHZhciBsdW0gPSBuZXcgbHVtaW5hdGkuTHVtaW5hdGkoY29uZmlnKTtcblxuICAgICAgbHVtLmdldFByb3h5KClcbiAgICAgICAgLnRoZW4ocHJveHkgPT4ge1xuICAgICAgICAgIGV4cGVjdChwcm94eSkudG8ubWF0Y2goL2N1c3RvbWVyXFwtdXNlclxcLWRucy8pO1xuICAgICAgICAgIGV4cGVjdChwcm94eSkudG8ubWF0Y2goL1xcOnNlY3JldFxcQHF1eC8pO1xuICAgICAgICAgIGV4cGVjdChsb29rdXBNb2NrLmZpcnN0Q2FsbC5hcmdzWzBdKS50by5tYXRjaCgvc2VydmVyY291bnRyeS1nYi8pXG4gICAgICAgICAgbHVtLmhvc3QuY2xlYW51cCgpO1xuICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgnZG9lcyBub3QgbG9va3VwIHN1cGVyUHJveHkgYXMgYSBkZWZhdWx0JywgZG9uZSA9PiB7XG4gICAgICAgdmFyIGNvbmZpZyA9IHtcbiAgICAgICAgdXNlcm5hbWU6ICd1c2VyJyxcbiAgICAgICAgcGFzc3dvcmQ6ICdzZWNyZXQnLFxuICAgICAgfTtcblxuICAgICAgdmFyIGx1bSA9IG5ldyBsdW1pbmF0aS5MdW1pbmF0aShjb25maWcpO1xuXG4gICAgICBsdW0uZ2V0UHJveHkoKVxuICAgICAgICAudGhlbihwcm94eSA9PiB7XG4gICAgICAgICAgZXhwZWN0KGxvb2t1cE1vY2spLm5vdC50by5oYXZlLmJlZW4uY2FsbGVkO1xuICAgICAgICAgIGV4cGVjdChwcm94eSkudG8ubWF0Y2goL3pwcm94eVxcLmx1bWluYXRpXFwuaW8vKTtcbiAgICAgICAgICBkb25lKCk7XG4gICAgICAgIH0pXG4gICAgfSk7XG5cblxuICAgIGl0KCdpZ25vcmVzIGEgdXNlciB0cnlpbmcgdG8gY2FjaGUgaWYgaHR0cHMgaXMgc2V0IHRvIHRydWUnLCBkb25lID0+IHtcbiAgICAgICB2YXIgY29uZmlnID0ge1xuICAgICAgICAgdXNlcm5hbWU6ICd1c2VyJyxcbiAgICAgICAgIHBhc3N3b3JkOiAnc2VjcmV0JyxcbiAgICAgICAgIGh0dHBzOiB0cnVlLFxuICAgICAgICAgY2FjaGVTdXBlclByb3h5OiB0cnVlLFxuICAgICAgICAgY2FjaGVUaW1lb3V0OiAxMFxuICAgICAgfTtcblxuICAgICAgdmFyIGx1bSA9IG5ldyBsdW1pbmF0aS5MdW1pbmF0aShjb25maWcpO1xuXG4gICAgICBsdW0uZ2V0UHJveHkoKVxuICAgICAgICAudGhlbihwcm94eSA9PiB7XG4gICAgICAgICAgZXhwZWN0KGxvb2t1cE1vY2spLm5vdC50by5oYXZlLmJlZW4uY2FsbGVkO1xuICAgICAgICAgIGV4cGVjdChwcm94eSkudG8ubWF0Y2goL3pwcm94eVxcLmx1bWluYXRpXFwuaW8vKTtcbiAgICAgICAgICBkb25lKCk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG5cbiAgICBpdCgncmVmbGVjdHMgaHR0cHMsIGNvdW50cnksIGFuZCBkbnNSZXNvbHV0aW9uIG9wdGlvbnMgaW4gZmluYWwgc3RyaW5nJywgZG9uZSA9PiB7XG4gICAgICB2YXIgY29uZmlnID0ge1xuICAgICAgICB1c2VybmFtZTogJ3VzZXInLFxuICAgICAgICBwYXNzd29yZDogJ3NlY3JldCcsXG4gICAgICAgIGRuc1Jlc29sdXRpb246ICdyZW1vdGUnLFxuICAgICAgICBleGl0TG9jYXRpb246ICdubCcsXG4gICAgICAgIGh0dHBzOiB0cnVlXG4gICAgICB9O1xuXG4gICAgICB2YXIgbHVtID0gbmV3IGx1bWluYXRpLkx1bWluYXRpKGNvbmZpZyk7XG5cbiAgICAgIGx1bS5nZXRQcm94eSgpXG4gICAgICAgIC50aGVuKHByb3h5ID0+IHtcbiAgICAgICAgICBleHBlY3QocHJveHkpLnRvLm1hdGNoKC9kbnNcXC1yZW1vdGUvKTtcbiAgICAgICAgICBleHBlY3QocHJveHkpLnRvLm1hdGNoKC9jb3VudHJ5XFwtbmwvKTtcblxuICAgICAgICAgIC8vIHNob3VsZCBub3QgY2FsbCBsb29rdXAgd2hlbiBodHRwcyBpcyB0cnVlIVxuICAgICAgICAgIGV4cGVjdChsb29rdXBNb2NrKS5ub3QudG8uaGF2ZS5iZWVuLmNhbGxlZDtcbiAgICAgICAgICBsdW0uaG9zdC5jbGVhbnVwKCk7XG4gICAgICAgICAgZG9uZSgpO1xuICAgICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdyZWZsZWN0cyBzdXBlclByb3h5TG9jYXRpb24gaW4gaXRzIGNhbGwgdG8gbG9va3VwIGxvY2F0aW9uJywgKCkgPT4ge1xuICAgICAgdmFyIGNvbmZpZyA9IHtcbiAgICAgICAgdXNlcm5hbWU6ICd1c2VyJyxcbiAgICAgICAgcGFzc3dvcmQ6ICdzZWNyZXQnLFxuICAgICAgICBzdXBlclByb3h5TG9jYXRpb246ICdubCcsXG4gICAgICAgIGNhY2hlU3VwZXJQcm94eTogdHJ1ZSxcbiAgICAgIH07XG5cbiAgICAgIHZhciBsdW0gPSBuZXcgbHVtaW5hdGkuTHVtaW5hdGkoY29uZmlnKTtcblxuICAgICAgbHVtLmdldFByb3h5KCk7XG4gICAgICBleHBlY3QobG9va3VwTW9jay5maXJzdENhbGwuYXJnc1swXSkudG8ubWF0Y2goL3NlcnZlcmNvdW50cnktbmwvKVxuICAgICAgbHVtLmhvc3QuY2xlYW51cCgpO1xuICAgIH0pO1xuICB9KTtcbn0pXG4iXX0=